---
title: "Análisis del tipo de cambio USD/PEN alrededor de elecciones peruanas"
author: "N. Leon"
date: "15.01.2026"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 1. Introducción

La hipótesis de esta investigación (breve y exploratoria) es:

> El tipo de cambio USD/PEN se aprecia en los $N$ días previos a las elecciones y se deprecia en los $N$ días posteriores a las elecciones.

siendo $N=5,10,15,20,30,60,90,120$ días.

### **1.1. Contexto y Motivación**

Las elecciones presidenciales peruanas se caracterizan por un sistema de dos vueltas, donde la primera ronda selecciona a los dos candidatos más votados y la segunda ronda define al ganador. Este proceso genera distintos períodos de incertidumbre política que pueden afectar diferencialmente el comportamiento del tipo de cambio:

1.  **Primera vuelta:** Alta incertidumbre sobre el abanico de posibles ganadores

2.  **Segunda vuelta:** Incertidumbre reducida a dos opciones, pero potencialmente mayor polarización

### **1.2. Metodología General**

El análisis sigue un enfoque por etapas:

1.  **Preprocesamiento de datos:** Limpieza, transformación y segmentación de datos (creando tres conjuntos: primera vuelta, segunda vuelta y total)

2.  **Análisis descriptivo:** Visualización de patrones temporales alrededor de eventos electorales

3.  **Modelado estadístico:** Pruebas de hipótesis adaptadas al tamaño muestral limitado

4.  **Recomendaciones especulativas:** Estrategias de trading exploratorias basadas en hallazgos

# 2. Configuración

```{r settings, warning=FALSE, error=FALSE, echo=TRUE, results='hide', message=FALSE}
# Load libraries
library(tidyverse)
library(summariser)
library(dplyr)
library(lubridate)
library(quantmod)
library(ggplot2)
library(knitr)
library(scales)
library(ggrepel)
library(patchwork)
library(purrr)

set.seed(42) # Set random seed for reproducibility
theme_set(theme_minimal(base_size = 12)) # Set plotting theme
```

# 3. Preprocesamiento de datos

Primero se preprocesan los cierres del tipo de cambio desde 2004 hasta 2026. Esta inforamción es extraída del [repositorio del BCRP.](https://estadisticas.bcrp.gob.pe/estadisticas/series/diarias/resultados/PD04646PD/html)

```{r preprocess1, warning=FALSE}
df_ex_ra <- read.csv("./data/exchange_rate.csv")
df_ex_ra$value <- as.double(df_ex_ra$value)
df_ex_ra$date <- as.Date(df_ex_ra$date, "%d.%m.%y")
df_ex_ra <- df_ex_ra %>% arrange(date)
summary(df_ex_ra)
```

En el caso de la información respecto a las elecciones, se creó un archivo de forma manual extrayendo información de Wikipedia. La información divide entre rondas electorales (primera y segunda).

```{r preprocess2}
df_elect <- read.csv("./data/elections.csv", header = TRUE, sep = ",", dec = ".",)
df_elect$date <- as.Date(df_elect$date, "%d.%m.%y")
df_elect$round <- as.factor(df_elect$round)
df_elect$winner <- as.factor(df_elect$winner)
summary(df_elect)
```

Siguiendo la metodología de la Subsección 1.2., se generan tres datasets separados para el análisis comparativo.

```{r preprocess3}
df_total <- df_elect # 1. TODAS las elecciones (primera + segunda vuelta)
df_first<- df_elect %>% filter(round == "first") # 2. Solo PRIMERA vuelta
df_second <- df_elect %>% filter(round == "second") # 3. Solo SEGUNDA vuelta
```

En general, se trata de 4 elecciones generales, cada una con una primera y segunda vuelta desde el 2004 hasta 2025

```{r plot1, include=TRUE, echo=FALSE}
p1 <- ggplot() +
  geom_line(data = df_ex_ra, aes(x = date, y = value), 
            color = "steelblue", alpha = 0.7) +
  geom_vline(data = df_total, aes(xintercept = date), 
             color = "red", linetype = "dashed", alpha = 0.5) +
  labs(title = "Tipo de cambio USD/PEN con fechas electorales",
       x = "Fecha", y = "USD/PEN") +
  scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(p1)
```

# 4. Función principal

La función principal calcula los retornos previos y posterios según el número de días elegido.

```{r main_function}
# Function to calculate pre and post returns for a given window
calculate_window_returns <- function(df_exchange, df_elections, window_days) {
  results <- list()
  
  election_dates <- df_elections$date
  
  for(i in seq_along(election_dates)) {
    election_date <- election_dates[i]
    
    # Find the closest trading day to the election date
    date_diffs <- abs(df_exchange$date - election_date)
    election_idx <- which.min(date_diffs)
    closest_date <- df_exchange$date[election_idx]
    
    # Check if the closest date is within a reasonable range
    if(as.numeric(difftime(closest_date, election_date, units = "days")) > 2) {
      warning(paste("No exchange rate data found within 2 days of election date:", 
                    election_date))
      next
    }
    
    # Find pre-election window start (N trading days before)
    pre_window_start_date <- election_date - window_days
    
    # Find the closest trading day to pre_window_start_date
    pre_diffs <- abs(df_exchange$date - pre_window_start_date)
    pre_start_idx <- which.min(pre_diffs)
    pre_start_date <- df_exchange$date[pre_start_idx]
    
    # Find pre-election window end (1 trading day before election)
    dates_before <- df_exchange$date[df_exchange$date < election_date]
    if(length(dates_before) == 0) {
      warning(paste("No exchange rate data before election date:", election_date))
      next
    }
    pre_end_date <- max(dates_before)
    pre_end_idx <- which(df_exchange$date == pre_end_date)
    
    # Find post-election window start (1 trading day after election)
    dates_after <- df_exchange$date[df_exchange$date > election_date]
    if(length(dates_after) == 0) {
      warning(paste("No exchange rate data after election date:", election_date))
      next
    }
    post_start_date <- min(dates_after)
    post_start_idx <- which(df_exchange$date == post_start_date)
    
    post_window_end_date <- election_date + window_days
    
    # Find the closest trading day to post_window_end_date
    post_diffs <- abs(df_exchange$date - post_window_end_date)
    post_end_idx <- which.min(post_diffs)
    post_end_date <- df_exchange$date[post_end_idx]
    
    # Ensure indices are within bounds
    if(pre_start_idx >= 1 && pre_start_idx <= nrow(df_exchange) &&
       pre_end_idx >= 1 && pre_end_idx <= nrow(df_exchange) &&
       post_start_idx >= 1 && post_start_idx <= nrow(df_exchange) &&
       post_end_idx >= 1 && post_end_idx <= nrow(df_exchange)) {
      
      pre_start_price <- df_exchange$value[pre_start_idx]
      pre_end_price <- df_exchange$value[pre_end_idx]
      
      post_start_price <- df_exchange$value[post_start_idx]
      post_end_price <- df_exchange$value[post_end_idx]
      
      # Calculate percentage returns
      pre_return <- (pre_end_price - pre_start_price) / pre_start_price * 100
      post_return <- (post_end_price - post_start_price) / post_start_price * 100
      
      # Calculate actual number of calendar days in each window
      pre_calendar_days <- as.numeric(difftime(pre_end_date, pre_start_date, units = "days"))
      post_calendar_days <- as.numeric(difftime(post_end_date, post_start_date, units = "days"))
      
      results[[i]] <- tibble(
        election_id = i,
        election_date = election_date,
        round = ifelse("round" %in% names(df_elections), 
                              df_elections$round[i], "none"),
        winner = ifelse("winner" %in% names(df_elections),
                              df_elections$winner[i], "none"), #TODO: FIX
        window_days = window_days,
        pre_start_date = pre_start_date,
        pre_end_date = pre_end_date,
        post_start_date = post_start_date,
        post_end_date = post_end_date,
        pre_calendar_days = pre_calendar_days,
        post_calendar_days = post_calendar_days,
        pre_start_price = pre_start_price,
        pre_end_price = pre_end_price,
        post_start_price = post_start_price,
        post_end_price = post_end_price,
        pre_return_pct = pre_return,
        post_return_pct = post_return,
        net_effect = pre_return - post_return,
        # Annualized returns for comparison across different window lengths
        pre_annualized = ifelse(pre_calendar_days > 0, 
                               (1 + pre_return/100)^(365/pre_calendar_days) - 1,
                               NA),
        post_annualized = ifelse(post_calendar_days > 0,
                                (1 + post_return/100)^(365/post_calendar_days) - 1,
                                NA)
      )
    }
  }
  
  # Combine all elections for this window
  if(length(results) > 0) {
    bind_rows(results)
  } else {
    tibble()  # Return empty tibble if no results
  }
}
```

## 4.1. Funciones secundarias

Las funciones secundarias automatizan el cálculo de la función principal.

```{r secondary_function}
# Wrapper function to calculate for multiple windows
calculate_all_windows <- function(df_exchange, df_elections, windows = c(5, 10)) {
  all_results <- map_df(windows, ~calculate_window_returns(df_exchange, df_elections, .x))
  
  all_results <- all_results %>%
    group_by(window_days) %>%
    mutate(
      pre_rank = rank(-pre_return_pct),  # Rank by pre-return (highest = 1)
      post_rank = rank(post_return_pct)   # Rank by post-return (lowest = 1)
    ) %>%
    ungroup()
  
  return(all_results)
}

# Wrapper function to create summary statistics
create_summary_table <- function(all_results) {
  summary_table <- all_results %>%
    group_by(window_days) %>%
    summarise(
      n_elections = n(),
      avg_pre_return = mean(pre_return_pct, na.rm = TRUE),
      median_pre_return = median(pre_return_pct, na.rm = TRUE),
      sd_pre_return = sd(pre_return_pct, na.rm = TRUE),
      avg_post_return = mean(post_return_pct, na.rm = TRUE),
      median_post_return = median(post_return_pct, na.rm = TRUE),
      sd_post_return = sd(post_return_pct, na.rm = TRUE),
      pre_positive_pct = mean(pre_return_pct > 0, na.rm = TRUE) * 100,
      post_negative_pct = mean(post_return_pct < 0, na.rm = TRUE) * 100,
      avg_net_effect = mean(net_effect, na.rm = TRUE)
    ) %>%
    mutate(across(where(is.numeric), ~round(., 3)))
  return(summary_table)
}
```

Considerando los datasets de la Sección 3 y la metodología de la Sección 1, se obtienen los siguientes resultados:

```{r the_magic}
windows <- c(5, 10, 15, 20, 30, 45, 60, 75, 90, 105, 120)

total_results <- calculate_all_windows(df_ex_ra, df_elect, windows)
total_table <- create_summary_table(total_results)

first_results <- calculate_all_windows(df_ex_ra, df_first, windows)
first_table <- create_summary_table(first_results)

second_results <- calculate_all_windows(df_ex_ra, df_second, windows)
second_table <- create_summary_table(second_results)
```

# 5. Resultados

## 5.1. Resultados generales

```{r res1}
kable(total_table[c(1,3,5,6,8)])
kable(total_table[c(9:11)])
```

```{r res1_plot1, , include=TRUE, echo=FALSE}
plot_data <- total_table %>%
  select(window_days, avg_pre_return, avg_post_return) %>%
  pivot_longer(cols = c(avg_pre_return, avg_post_return),
               names_to = "period",
               values_to = "return_pct") %>%
  mutate(period = ifelse(period == "avg_pre_return",
                         "Pre-Election", "Post-Election"))

hit_data <- total_table %>%
  select(window_days, pre_positive_pct, post_negative_pct) %>%
  pivot_longer(cols = c(pre_positive_pct, post_negative_pct),
               names_to = "metric",
               values_to = "percentage") %>%
  mutate(metric = ifelse(metric == "pre_positive_pct",
                         "% Elections with Pre-Appreciation",
                         "% Elections with Post-Depreciation"))

# Plot 1: Average returns by window
p2 <- ggplot(plot_data, aes(x = factor(window_days), y = return_pct, fill = period)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  labs(title = "Average USD/PEN Returns Around Elections",
       subtitle = "By Analysis Window",
       x = "Window (Days)",
       y = "Average Return (%)",
       fill = "Period") +
  scale_fill_manual(values = c("Pre-Election" = "#2E8B57",
                               "Post-Election" = "#CD5C5C")) +
  theme(legend.position = "bottom")

print(p2)

# Plot 2: Hit rate (frequency of expected moves)
p3 <- ggplot(hit_data, aes(x = factor(window_days), y = percentage,
                           color = metric, group = metric)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  geom_hline(yintercept = 50, linetype = "dashed", color = "gray40") +
  labs(title = "Consistency of Election Effect",
       subtitle = "Percentage of elections following the hypothesized pattern",
       x = "Window (Days)",
       y = "Percentage of Elections (%)",
       color = "Metric") +
  scale_color_manual(values = c("#2E8B57", "#CD5C5C")) +
  ylim(0, 100) +
  theme(legend.position = "bottom")

print(p3)

# # Plot 3: Individual election outcomes (example: 60-day window)
# individual_data <- total_results %>%
#   filter(window_days == 60) %>%
#   mutate(election_label = paste0(year(election_date), "\n",
#                                  round(pre_return_pct, 1), "% / ",
#                                  round(post_return_pct, 1), "%"))

# p4 <- ggplot(individual_data, aes(x = pre_return_pct, y = post_return_pct)) +
#   geom_point(aes(color = factor(year(election_date))), size = 4) +
#   geom_text_repel(aes(label = year(election_date)), size = 3.5) +
#   geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
#   geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
#   labs(title = "Individual Election Outcomes (60-Day Window)",
#        subtitle = "Each point represents one election\nFormat: Year | Pre-Return% / Post-Return%",
#        x = "Pre-Election Return (%)",
#        y = "Post-Election Return (%)",
#        color = "Election Year") +
#   theme(legend.position = "none")
# 
# print(p4)
```

## 5.1. Resultados primera vuelta

```{r res2}
kable(first_table[c(1,3,5,6,8)])
kable(first_table[c(9:11)])
```

```{r res2_plot1, , include=TRUE, echo=FALSE}
plot_data <- first_table %>%
  select(window_days, avg_pre_return, avg_post_return) %>%
  pivot_longer(cols = c(avg_pre_return, avg_post_return),
               names_to = "period",
               values_to = "return_pct") %>%
  mutate(period = ifelse(period == "avg_pre_return",
                         "Pre-Election", "Post-Election"))

hit_data <- first_table %>%
  select(window_days, pre_positive_pct, post_negative_pct) %>%
  pivot_longer(cols = c(pre_positive_pct, post_negative_pct),
               names_to = "metric",
               values_to = "percentage") %>%
  mutate(metric = ifelse(metric == "pre_positive_pct",
                         "% Elections with Pre-Appreciation",
                         "% Elections with Post-Depreciation"))

# Plot 1: Average returns by window
p2 <- ggplot(plot_data, aes(x = factor(window_days), y = return_pct, fill = period)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  labs(title = "Average USD/PEN Returns Around Elections",
       subtitle = "By Analysis Window",
       x = "Window (Days)",
       y = "Average Return (%)",
       fill = "Period") +
  scale_fill_manual(values = c("Pre-Election" = "#2E8B57",
                               "Post-Election" = "#CD5C5C")) +
  theme(legend.position = "bottom")

print(p2)

# Plot 2: Hit rate (frequency of expected moves)
p3 <- ggplot(hit_data, aes(x = factor(window_days), y = percentage,
                           color = metric, group = metric)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  geom_hline(yintercept = 50, linetype = "dashed", color = "gray40") +
  labs(title = "Consistency of Election Effect",
       subtitle = "Percentage of elections following the hypothesized pattern",
       x = "Window (Days)",
       y = "Percentage of Elections (%)",
       color = "Metric") +
  scale_color_manual(values = c("#2E8B57", "#CD5C5C")) +
  ylim(0, 100) +
  theme(legend.position = "bottom")

print(p3)

# Plot 3: Individual election outcomes (example: 60-day window)
# individual_data <- first_results %>%
#   filter(window_days == 60) %>%
#   mutate(election_label = paste0(year(election_date), "\n",
#                                  round(pre_return_pct, 1), "% / ",
#                                  round(post_return_pct, 1), "%"))
# 
# p4 <- ggplot(individual_data, aes(x = pre_return_pct, y = post_return_pct)) +
#   geom_point(aes(color = factor(year(election_date))), size = 4) +
#   geom_text_repel(aes(label = year(election_date)), size = 3.5) +
#   geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
#   geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
#   labs(title = "Individual Election Outcomes (60-Day Window)",
#        subtitle = "Each point represents one election\nFormat: Year | Pre-Return% / Post-Return%",
#        x = "Pre-Election Return (%)",
#        y = "Post-Election Return (%)",
#        color = "Election Year") +
#   theme(legend.position = "none")
# 
# print(p4)
```

## 5.2. Resultados segunda vuelta

```{r res3}
kable(second_table[c(1,3,5,6,8)])
kable(second_table[c(9:11)])
```

```{r res3_plot1, , include=TRUE, echo=FALSE}
plot_data <- second_table %>%
  select(window_days, avg_pre_return, avg_post_return) %>%
  pivot_longer(cols = c(avg_pre_return, avg_post_return),
               names_to = "period",
               values_to = "return_pct") %>%
  mutate(period = ifelse(period == "avg_pre_return",
                         "Pre-Election", "Post-Election"))

hit_data <- second_table %>%
  select(window_days, pre_positive_pct, post_negative_pct) %>%
  pivot_longer(cols = c(pre_positive_pct, post_negative_pct),
               names_to = "metric",
               values_to = "percentage") %>%
  mutate(metric = ifelse(metric == "pre_positive_pct",
                         "% Elections with Pre-Appreciation",
                         "% Elections with Post-Depreciation"))

# Plot 1: Average returns by window
p2 <- ggplot(plot_data, aes(x = factor(window_days), y = return_pct, fill = period)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.8)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
  labs(title = "Average USD/PEN Returns Around Elections",
       subtitle = "By Analysis Window",
       x = "Window (Days)",
       y = "Average Return (%)",
       fill = "Period") +
  scale_fill_manual(values = c("Pre-Election" = "#2E8B57",
                               "Post-Election" = "#CD5C5C")) +
  theme(legend.position = "bottom")

print(p2)

# Plot 2: Hit rate (frequency of expected moves)
p3 <- ggplot(hit_data, aes(x = factor(window_days), y = percentage,
                           color = metric, group = metric)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 3) +
  geom_hline(yintercept = 50, linetype = "dashed", color = "gray40") +
  labs(title = "Consistency of Election Effect",
       subtitle = "Percentage of elections following the hypothesized pattern",
       x = "Window (Days)",
       y = "Percentage of Elections (%)",
       color = "Metric") +
  scale_color_manual(values = c("#2E8B57", "#CD5C5C")) +
  ylim(0, 100) +
  theme(legend.position = "bottom")

print(p3)

# Plot 3: Individual election outcomes (example: 60-day window)
# individual_data <- second_results %>%
#   filter(window_days == 60) %>%
#   mutate(election_label = paste0(year(election_date), "\n",
#                                  round(pre_return_pct, 1), "% / ",
#                                  round(post_return_pct, 1), "%"))
# 
# p4 <- ggplot(individual_data, aes(x = pre_return_pct, y = post_return_pct)) +
#   geom_point(aes(color = factor(year(election_date))), size = 4) +
#   geom_text_repel(aes(label = year(election_date)), size = 3.5) +
#   geom_hline(yintercept = 0, linetype = "dashed", color = "gray40") +
#   geom_vline(xintercept = 0, linetype = "dashed", color = "gray40") +
#   labs(title = "Individual Election Outcomes (60-Day Window)",
#        subtitle = "Each point represents one election\nFormat: Year | Pre-Return% / Post-Return%",
#        x = "Pre-Election Return (%)",
#        y = "Post-Election Return (%)",
#        color = "Election Year") +
#   theme(legend.position = "none")
# 
# print(p4)
```

# 6. Análisis de resultados

En base a los resultados y las visualizaciones, podemos adapatar las hipótesis:

> a)  El tipo de cambio USD/PEN se aprecia en los 10 (+/- 5) días previos a la primer vuelta.
>
> b)  El tipo de cambio USD/PEN se aprecia en los 30 (+/- 15) días previos a la primer vuelta.
>
> c)  El tipo de cambio USD/PEN se aprecia en los 15 (+/- 5) días previos a la segunda vuelta.
>
> d)  El tipo de cambio USD/PEN se aprecia en los 45 (+/- 15) días previos a la segunda vuelta.
>
> e)  El tipo de cambio USD/PEN se deprecia en los 10 (+/- 5) días posteriores a la segunda vuelta.

Para confirmar estas hipótesis se realizarán modelos estadísticos.

## 6.1. Hipótesis a - b

Para confirmar/negar estas hipótesis se construye un modelo **Event study + bootstrap (permutation test)**, donde se evalúa si el retorno alrededor del evento electoral es estadísticamente distinto de cero **en promedio.**

```{r hipotesis_1}
# Preprocesar a retornos logarítmicos (más sensibles a cambios mínimos)
df_ex_ra_test <- df_ex_ra %>%
  arrange(date) %>%
  mutate(
    ret = log(value) - log(lag(value))
  ) %>%
  filter(!is.na(ret))

# Extraer ventana de eventos alrededor del evento
get_event_window <- function(df, event_date, pre_days, post_days) {

  idx_event <- which.min(abs(df$date - event_date))

  start_idx <- idx_event - pre_days
  end_idx   <- idx_event + post_days

  if (start_idx < 1 || end_idx > nrow(df)) {
    return(NULL)
  }

  tibble(
    day = -pre_days:post_days,
    ret = df$ret[start_idx:end_idx]
  )
}

# Calcula Retornos acumulados (CAR)
compute_car <- function(event_window, from, to) {
  event_window %>%
    filter(day >= from, day <= to) %>%
    summarise(car = sum(ret)) %>%
    pull(car)
}

# Hipótesis:
# H0: mediana(CAR) = 0
# H1: mediana(CAR) > 0 (pre)

run_sign_test <- function(df_ex, df_events, pre_days, post_days,
                          car_from, car_to) {

  cars <- map_dbl(df_events$date, function(d) {
    ew <- get_event_window(df_ex, d, pre_days, post_days)
    if (is.null(ew)) return(NA_real_)
    compute_car(ew, car_from, car_to)
  })

  cars <- na.omit(cars)

  test <- binom.test(
    x = sum(cars > 0),
    n = length(cars),
    p = 0.5,
    alternative = ifelse(car_to < 0, "less", "greater")
  )

  list(
    cars = cars,
    test = test
  )
}

run_bootstrap_test <- function(df_ex, df_events,
                               pre_days, post_days,
                               car_from, car_to,
                               n_boot = 5000,
                               min_gap = 30) {

  # CAR observado
  observed_cars <- map_dbl(df_events$date, function(d) {
    ew <- get_event_window(df_ex, d, pre_days, post_days)
    if (is.null(ew)) return(NA_real_)
    compute_car(ew, car_from, car_to)
  })

  observed_mean <- mean(observed_cars, na.rm = TRUE)

  # Fechas elegibles
  valid_dates <- df_ex$date[
    (df_ex$date > min(df_ex$date) + pre_days + min_gap) &
    (df_ex$date < max(df_ex$date) - post_days - min_gap)
  ]

  # Bootstrap
  boot_means <- replicate(n_boot, {

    fake_dates <- sample(valid_dates, nrow(df_events))

    fake_cars <- map_dbl(fake_dates, function(d) {
      ew <- get_event_window(df_ex, d, pre_days, post_days)
      if (is.null(ew)) return(NA_real_)
      compute_car(ew, car_from, car_to)
    })

    mean(fake_cars, na.rm = TRUE)
  })

  p_value <- mean(
    if (observed_mean > 0)
      boot_means >= observed_mean
    else
      boot_means <= observed_mean
  )

  list(
    observed_mean = observed_mean,
    boot_distribution = boot_means,
    p_value = p_value
  )
}
```

> a\. El tipo de cambio USD/PEN se aprecia en los 10 (+/- 5) días previos a la primer vuelta.

```{r test_a, cache=TRUE}
sign_test_a <- run_sign_test(
  df_ex = df_ex_ra_test,
  df_events = df_first,
  pre_days = 15,
  post_days = 1,
  car_from = -15,
  car_to = -5
)

sign_test_a$test

boot_test_a <- run_bootstrap_test(
  df_ex = df_ex_ra_test,
  df_events = df_first,
  pre_days = 15,
  post_days = 1,
  car_from = -15,
  car_to = -5,
  n_boot = 10000
)

boot_test_a$observed_mean
boot_test_a$p_value
```

> b\. El tipo de cambio USD/PEN se aprecia en los 30 (+/- 15) días previos a la primer vuelta.

```{r test_b, cache=TRUE}
sign_test_b <- run_sign_test(
  df_ex = df_ex_ra_test,
  df_events = df_first,
  pre_days = 45,
  post_days = 15,
  car_from = -45,
  car_to = -15
)

sign_test_b$test

boot_test_b <- run_bootstrap_test(
  df_ex = df_ex_ra_test,
  df_events = df_first,
  pre_days = 45,
  post_days = 15,
  car_from = -45,
  car_to = -15,
  n_boot = 10000
)

boot_test_b$observed_mean
boot_test_b$p_value
```

## 6.2. Hipótesis c - d

> c\. El tipo de cambio USD/PEN se aprecia en los 15 (+/- 5) días previos a la segunda vuelta.

```{r test_c, cache=TRUE}
sign_test_c <- run_sign_test(
  df_ex = df_ex_ra_test,
  df_events = df_second,
  pre_days = 45,
  post_days = 15,
  car_from = -45,
  car_to = -15
)

sign_test_c$test

boot_test_c <- run_bootstrap_test(
  df_ex = df_ex_ra_test,
  df_events = df_second,
  pre_days = 45,
  post_days = 15,
  car_from = -45,
  car_to = -15,
  n_boot = 10000
)

boot_test_c$observed_mean
boot_test_c$p_value
```

> d\. El tipo de cambio USD/PEN se aprecia en los 45 (+/- 15) días previos a la segunda vuelta.

```{r test_d, cache=TRUE}
sign_test_d <- run_sign_test(
  df_ex = df_ex_ra_test,
  df_events = df_second,
  pre_days = 60,
  post_days = 30,
  car_from = -60,
  car_to = -30
)

sign_test_d$test

boot_test_d <- run_bootstrap_test(
  df_ex = df_ex_ra_test,
  df_events = df_second,
  pre_days = 60,
  post_days = 30,
  car_from = -60,
  car_to = -30,
  n_boot = 10000
)

boot_test_d$observed_mean
boot_test_d$p_value
```

## 6.3. Hipótesis e

> e\. El tipo de cambio USD/PEN se deprecia en los 10 (+/- 5) días posteriores a la segunda vuelta.

```{r test_e, cache=TRUE}
sign_test_e <- run_sign_test(
  df_ex = df_ex_ra_test,
  df_events = df_second,
  pre_days = 5,
  post_days = 15,
  car_from = 5,
  car_to = 15
)

sign_test_e$test

boot_test_e <- run_bootstrap_test(
  df_ex = df_ex_ra_test,
  df_events = df_second,
  pre_days = 5,
  post_days = 15,
  car_from = 5,
  car_to = 15,
  n_boot = 10000
)

boot_test_e$observed_mean
boot_test_e$p_value
```

# 7. Discusión

Se analizan resultados finales.

# 8. Cálculo de retorno

Se seleccionan las hipótesis más válidas y se calcula el retorno

# 8. Recomendaciones

Basándonos en los hallazgos descriptivos (no estadísticamente significativos pero consistentes en promedio), simulamos tres estrategias:
Estrategia A: "Pre-Electoral Corto"

    Señal: Comprar USD 5 días antes del inicio de la ventana pre-electoral

    Cierre: Vender USD 1 día antes de la elección

    Ventanas:

        Primera vuelta: 10±5 días (15 a 5 días antes)

        Segunda vuelta: 15±5 días (20 a 10 días antes)

Estrategia B: "Pre-Electoral Largo"

    Señal: Comprar USD al inicio de la ventana más larga con retorno positivo

    Cierre: Vender USD 1 día antes de la elección

    Ventanas:

        Primera vuelta: 30±15 días (45 a 15 días antes)

        Segunda vuelta: 45±15 días (60 a 30 días antes)

Estrategia C: "Post-Electoral" (hipótesis no confirmada)

    Señal: Vender USD (corto) 1 día después de la elección

    Cierre: Cubrir posición 10±5 días después (5 a 15 días post-elección)

    Solo segunda vuelta (según hipótesis e)
<!-- # 4) T-Tests -->

<!-- ```{r t_test} -->

<!-- if (nrow(df_elect) > 4) { -->

<!--   significance_results <- tibble() -->

<!-- for(w in windows) { -->

<!--   window_data <- all_results %>% filter(window_days == w) -->

<!--   if(nrow(window_data) > 1) { -->

<!--     pre_test <- t.test(window_data$pre_return_pct, alternative = "greater") -->

<!--     post_test <- t.test(window_data$post_return_pct, alternative = "less") -->

<!--     paired_test <- t.test(window_data$pre_return_pct,  -->

<!--                           window_data$post_return_pct,  -->

<!--                           paired = TRUE,  -->

<!--                           alternative = "greater") -->

<!--     significance_results <- bind_rows( -->

<!--       significance_results, -->

<!--       tibble( -->

<!--         window_days = w, -->

<!--         test = "Pre > 0", -->

<!--         p_value = round(pre_test$p.value, 4), -->

<!--         significant = pre_test$p.value < 0.05, -->

<!--         statistic = round(pre_test$statistic, 3) -->

<!--       ), -->

<!--       tibble( -->

<!--         window_days = w, -->

<!--         test = "Post < 0",  -->

<!--         p_value = round(post_test$p.value, 4), -->

<!--         significant = post_test$p.value < 0.05, -->

<!--         statistic = round(post_test$statistic, 3) -->

<!--       ), -->

<!--       tibble( -->

<!--         window_days = w, -->

<!--         test = "Pre > Post", -->

<!--         p_value = round(paired_test$p.value, 4), -->

<!--         significant = paired_test$p.value < 0.05, -->

<!--         statistic = round(paired_test$statistic, 3) -->

<!--       ) -->

<!--     ) -->

<!--   } -->

<!-- } -->

<!--   print(significance_results) -->

<!-- } -->

<!-- ``` -->

<!-- # 5) Retorno acumulado -->

<!-- ## 5.1) Función principal -->

<!-- ```{r cumulative_return} -->

<!-- calculate_cumulative_returns_simple <- function(df_exchange, df_elections, max_window = 120) { -->

<!--   df_exchange <- df_exchange %>% arrange(date) -->

<!--   election_paths <- list() -->

<!--   for(i in 1:nrow(df_elections)) { -->

<!--     election_date <- df_elections$date[i] -->

<!--     # Find exact or closest election date in exchange data -->

<!--     election_idx <- which(df_exchange$date == election_date) -->

<!--     if(length(election_idx) == 0) { -->

<!--       # Find the next trading day -->

<!--       possible_dates <- df_exchange$date[df_exchange$date >= election_date] -->

<!--       if(length(possible_dates) == 0) next -->

<!--       election_idx <- which(df_exchange$date == min(possible_dates)) -->

<!--     } -->

<!--     # Check if we have enough data before and after -->

<!--     if(election_idx - max_window < 1 ||  -->

<!--        election_idx + max_window > nrow(df_exchange)) { -->

<!--       next -->

<!--     } -->

<!--     # Extract prices around election -->

<!--     prices <- df_exchange$value[(election_idx - max_window):(election_idx + max_window)] -->

<!--     base_price <- df_exchange$value[election_idx] -->

<!--     # Calculate cumulative returns -->

<!--     cum_returns <- (prices - base_price) / base_price * 100 -->

<!--     election_paths[[i]] <- tibble( -->

<!--       election_id = i, -->

<!--       election_date = election_date, -->

<!--       days_relative = (-max_window):max_window, -->

<!--       cum_return = cum_returns -->

<!--     ) -->

<!--   } -->

<!--   # Combine all election paths -->

<!--   if(length(election_paths) == 0) { -->

<!--     return(tibble(days_relative = integer(), avg_cum_return = numeric())) -->

<!--   } -->

<!--   all_paths <- bind_rows(election_paths) -->

<!--   # Calculate summary statistics -->

<!--   cumulative_returns <- all_paths %>% -->

<!--     group_by(days_relative) %>% -->

<!--     summarise( -->

<!--       avg_cum_return = mean(cum_return, na.rm = TRUE), -->

<!--       median_cum_return = median(cum_return, na.rm = TRUE), -->

<!--       sd_cum_return = sd(cum_return, na.rm = TRUE), -->

<!--       n_elections = n(), -->

<!--       cum_return_25 = quantile(cum_return, 0.25, na.rm = TRUE), -->

<!--       cum_return_75 = quantile(cum_return, 0.75, na.rm = TRUE), -->

<!--       .groups = 'drop' -->

<!--     ) %>% -->

<!--     mutate( -->

<!--       std_error = sd_cum_return / sqrt(n_elections), -->

<!--       ci_lower = avg_cum_return - 1.96 * std_error, -->

<!--       ci_upper = avg_cum_return + 1.96 * std_error, -->

<!--       # Add smoothed version -->

<!--       avg_cum_return_smooth = stats::filter(avg_cum_return, rep(1/7, 7), sides = 2) -->

<!--     ) -->

<!--   return(cumulative_returns) -->

<!-- } -->

<!-- cumulative_df <- calculate_cumulative_returns_simple(df_ex_ra, df_elect, max_window = 120) -->

<!-- ``` -->

<!-- ## 5.2) Resultados y visualización -->

<!-- ```{r plot5, echo=FALSE} -->

<!-- plot_cumulative_returns <- function(cumulative_df, max_window = 120) { -->

<!--   y_min <- min(cumulative_df$ci_lower, cumulative_df$cum_return_25, na.rm = TRUE) * 1.1 -->

<!--   y_max <- max(cumulative_df$ci_upper, cumulative_df$cum_return_75, na.rm = TRUE) * 1.1 -->

<!--   p <- ggplot(cumulative_df, aes(x = days_relative)) + -->

<!--     annotate("rect", xmin = -max_window, xmax = 0, ymin = y_min, ymax = y_max, -->

<!--              fill = "#2E8B57", alpha = 0.05) + -->

<!--     annotate("rect", xmin = 0, xmax = max_window, ymin = y_min, ymax = y_max, -->

<!--              fill = "#CD5C5C", alpha = 0.05) + -->

<!--     geom_ribbon(aes(ymin = ci_lower, ymax = ci_upper),  -->

<!--                 fill = "steelblue", alpha = 0.2) + -->

<!--     geom_ribbon(aes(ymin = cum_return_25, ymax = cum_return_75), -->

<!--                 fill = "gray70", alpha = 0.3) + -->

<!--     geom_line(aes(y = avg_cum_return), color = "steelblue", linewidth = 1.2) + -->

<!--     geom_line(aes(y = avg_cum_return_smooth), color = "darkblue",  -->

<!--               linewidth = 1, linetype = "dashed", alpha = 0.7) + -->

<!--     geom_hline(yintercept = 0, linetype = "solid", color = "gray40", linewidth = 0.5) + -->

<!--     geom_vline(xintercept = 0, linetype = "dashed", color = "red", linewidth = 0.8, alpha = 0.8) + -->

<!--     geom_point(data = cumulative_df %>% filter(days_relative == 0), -->

<!--                aes(y = avg_cum_return), color = "red", size = 4, shape = 19) + -->

<!--     annotate("text", x = -max_window/2, y = y_max * 0.9, -->

<!--              label = "PRE-ELECTION\n(Expected: USD UP)",  -->

<!--              color = "#2E8B57", size = 4.5, fontface = "bold", lineheight = 0.8) + -->

<!--     annotate("text", x = max_window/2, y = y_max * 0.9, -->

<!--              label = "POST-ELECTION\n(Expected: USD DOWN)",  -->

<!--              color = "#CD5C5C", size = 4.5, fontface = "bold", lineheight = 0.8) + -->

<!--     annotate("text", x = -max_window, y = y_min * 0.9, -->

<!--              label = paste("Pre-election return:",  -->

<!--                           sprintf("%+.2f%%",  -->

<!--                                   cumulative_df$avg_cum_return[cumulative_df$days_relative == -1]), -->

<!--                           "\nPost-election return:",  -->

<!--                           sprintf("%+.2f%%",  -->

<!--                                   cumulative_df$avg_cum_return[cumulative_df$days_relative == max_window])), -->

<!--              color = "gray30", size = 3.5, hjust = 0, vjust = 1, lineheight = 0.9) + -->

<!--     labs( -->

<!--       title = "Cumulative USD/PEN Returns Around Peruvian Elections", -->

<!--       subtitle = paste("Average across", unique(cumulative_df$n_elections),  -->

<!--                       "elections | Shaded areas: 95% CI (blue) & IQR (gray)"), -->

<!--       x = "Trading Days Relative to Election", -->

<!--       y = "Cumulative Return (%)", -->

<!--       caption = paste("Data:", min(df_elect$date), "to", max(df_elect$date), -->

<!--                      "| Dashed line: 7-day moving average") -->

<!--     ) + -->

<!--     scale_x_continuous( -->

<!--       breaks = seq(-max_window, max_window, by = 30), -->

<!--       labels = function(x) paste0(x, "\n", ifelse(x == 0, "Election", "")) -->

<!--     ) + -->

<!--     scale_y_continuous( -->

<!--       labels = function(x) paste0(sprintf("%+.1f", x), "%"), -->

<!--       breaks = scales::pretty_breaks(n = 10) -->

<!--     ) + -->

<!--     theme_minimal(base_size = 13) + -->

<!--     theme( -->

<!--       plot.title = element_text(face = "bold", hjust = 0.5, size = 16), -->

<!--       plot.subtitle = element_text(hjust = 0.5, color = "gray50", size = 11), -->

<!--       plot.caption = element_text(color = "gray60", size = 9, hjust = 1), -->

<!--       panel.grid.major = element_line(color = "gray90", linewidth = 0.3), -->

<!--       panel.grid.minor = element_blank(), -->

<!--       axis.text.x = element_text(angle = 0, hjust = 0.5), -->

<!--       legend.position = "none" -->

<!--     ) -->

<!--   return(p) -->

<!-- } -->

<!-- # Check if we have data -->

<!-- if(nrow(cumulative_df) > 0) { -->

<!--   cat("Number of elections included:", unique(cumulative_df$n_elections)[1], "\n") -->

<!--   cat("Date range covered:", min(cumulative_df$days_relative), "to",  -->

<!--       max(cumulative_df$days_relative), "days relative to election\n\n") -->

<!--   # Show key statistics -->

<!--   key_stats <- cumulative_df %>% -->

<!--     filter(days_relative %in% c(-120, -60, -30, -15, -1, 0, 1, 15, 30, 60, 120)) %>% -->

<!--     select(days_relative, avg_cum_return, n_elections) %>% -->

<!--     mutate(avg_cum_return = sprintf("%+.2f%%", avg_cum_return)) -->

<!--   cat("Key cumulative returns:\n") -->

<!--   print(key_stats) -->

<!--   p_cumulative <- plot_cumulative_returns(cumulative_df, max_window = 120) -->

<!--   print(p_cumulative) -->

<!-- } else { -->

<!--   cat("Warning: Could not calculate cumulative returns. Check your data.\n") -->

<!-- } -->

<!-- ``` -->

<!-- # 6) Conclusiones -->

<!-- ```{r conclusions, echo=FALSE} -->

<!-- # Create a final summary table -->

<!-- if (nrow(df_elect) > 4) { -->

<!--   final_summary <- summary_table %>% -->

<!--     left_join( -->

<!--       significance_results %>%  -->

<!--         filter(test == "Pre > Post") %>% -->

<!--         select(window_days, p_value_pre_post = p_value, significant_pre_post = significant), -->

<!--       by = "window_days" -->

<!--     ) %>% -->

<!--     select(window_days, n_elections, avg_pre_return, avg_post_return,  -->

<!--            avg_net_effect, pre_positive_pct, post_negative_pct,  -->

<!--            p_value_pre_post, significant_pre_post) -->

<!--   final_summary -->

<!--   for(i in 1:nrow(final_summary)) { -->

<!--     row <- final_summary[i,] -->

<!--     cat(sprintf("For the %d-day window:\n", row$window_days)) -->

<!--     cat(sprintf("- USD/PEN appreciated %.2f%% before elections\n", row$avg_pre_return)) -->

<!--     cat(sprintf("- USD/PEN depreciated %.2f%% after elections\n", abs(row$avg_post_return))) -->

<!--     cat(sprintf("- Net effect: %.2f%%\n", row$avg_net_effect)) -->

<!--     cat(sprintf("- %.0f%% of elections showed pre-election appreciation\n", row$pre_positive_pct)) -->

<!--     cat(sprintf("- %.0f%% of elections showed post-election depreciation\n", row$post_negative_pct)) -->

<!--     if(row$significant_pre_post) { -->

<!--       cat(sprintf("- Statistically significant: Pre > Post (p = %.4f) \n", row$p_value_pre_post)) -->

<!--     } else { -->

<!--       cat(sprintf("- Not statistically significant: p = %.4f\n", row$p_value_pre_post)) -->

<!--     } -->

<!--     cat("\n") -->

<!--   } -->

<!-- } -->

<!-- ``` -->
